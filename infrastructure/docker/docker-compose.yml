version: '3.8'

services:
  # ---------------------------------------------------------------------------
  # PostgreSQL (Bancos Relacionais)
  # Usado por: user-service, product-service, order-service
  # Por que? É robusto para dados transacionais (pedidos, pagamentos, usuarios)
  # ---------------------------------------------------------------------------
  postgres:
    image: postgres:15-alpine
    container_name: ecommerce-postgres
    environment:
      POSTGRES_USER: ${DB_USER}
      POSTGRES_PASSWORD: ${DB_PASSWORD}
      POSTGRES_DB: ${DB_NAME}
    # Portas mantidas para conectar via ferramentas externas (DBeaver/etc)
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
    networks:
      - ecommerce-network
    logging: &default-logging
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ---------------------------------------------------------------------------
  # MongoDB (Banco NoSQL)
  # Usado por: product-catalog (leitura rápida), logs, carrinho (talvez)
  # Por que? Flexível para dados que mudam muito de estrutura (ex: atributos de produtos)
  # ---------------------------------------------------------------------------
  mongo:
    image: mongo:6.0
    container_name: ecommerce-mongo
    command: [ "--wiredTigerCacheSizeGB", "0.25" ]
    ports:
      - "27017:27017"
    volumes:
      - mongo_data:/data/db
    networks:
      - ecommerce-network
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

  # ---------------------------------------------------------------------------
  # RabbitMQ (Message Broker)
  # Usado por: todos os serviços para comunicação assíncrona
  # Por que? Permite que o serviço de pedidos avise o estoque sem travar a requisição do usuário.
  # A interface de gestão fica na porta 15672 (login: guest/guest)
  # ---------------------------------------------------------------------------
  rabbitmq:
    image: rabbitmq:3.11-management-alpine
    container_name: ecommerce-rabbitmq
    ports:
      - "5672:5672"
      - "15672:15672"
    networks:
      - ecommerce-network
    logging: *default-logging
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'

networks:
  ecommerce-network:
    driver: bridge

volumes:
  postgres_data:
  mongo_data:
